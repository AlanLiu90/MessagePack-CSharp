<Project Sdk="Microsoft.NET.Sdk">

  <Import Project="..\SourceGenerator.props"/>

  <PropertyGroup>
    <DefineConstants>$(DefineConstants);UNITY</DefineConstants>
    <IsPackable>false</IsPackable>

    <!-- Mainly used for Unity, Unity 2021.3 has Roslyn 3.8.0 (https://docs.unity3d.com/Manual/roslyn-analyzers.html) -->
    <MicrosoftCodeAnalysisVersion>3.8.0</MicrosoftCodeAnalysisVersion>
  </PropertyGroup>

  <ItemGroup>
    <Compile Include="..\MessagePack.Generator\Transforms\**\*.cs" LinkBase="Transforms" />
    <Compile Include="..\MessagePack.Generator\CodeAnalysis\**\*.cs" LinkBase="CodeAnalysis" />
    <Compile Include="..\MessagePack.Generator\Utils\**\*.cs" LinkBase="Utils" />
    <Compile Include="..\MessagePack.Generator\IGeneratorContext.cs" />
    <Compile Include="..\MessagePack.Generator\MessagePackGenerator.Emit.cs" />
    <Compile Include="..\MessagePack.UnityClient\Assets\Scripts\MessagePack\Internal\AutomataKeyGen.cs" LinkBase="MessagePack\Internal" />
    <Compile Include="..\MessagePack.UnityClient\Assets\Scripts\MessagePack\SafeBitConverter.cs" LinkBase="MessagePack" />
    <Compile Include="..\MessagePack.UnityClient\Assets\Scripts\MessagePack\MessagePackSerializationException.cs" LinkBase="MessagePack" />
  </ItemGroup>

  <ItemGroup>
    <AdditionalFiles Include="..\MessagePack.Generator\AnalyzerReleases.Shipped.md" />
    <AdditionalFiles Include="..\MessagePack.Generator\AnalyzerReleases.Unshipped.md" />
  </ItemGroup>

  <Target Name="PackZip" BeforeTargets="Pack" DependsOnTargets="Build">
    <ItemGroup>
      <ZipFileContent Include="$(TargetPath)" />
    </ItemGroup>
    <PropertyGroup>
      <ZipStagingDirectory>$(IntermediateOutputPath)zip</ZipStagingDirectory>
    </PropertyGroup>
    <Copy SourceFiles="@(ZipFileContent)" DestinationFolder="$(ZipStagingDirectory)" />
    <ZipDirectory
      SourceDirectory="$(ZipStagingDirectory)"
      DestinationFile="$(PackageOutputPath)MessagePack.SourceGenerator.Unity.zip"
      Overwrite="true"/>
  </Target>
</Project>
